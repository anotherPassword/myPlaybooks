#powershell variables test
---
- name: Set Environment and Variables
  hosts: all
  vars:
    #these are top level vars, can't populate 'surveyvars' as it is not top level?
    vmName: ""
    OS: ""
    Application: ""
    Tier: ""
    Environment: ""
    Location: ""
    SQL: ""
    #action pshell script will perform
    pshellScriptAction: ""
    #populate surveyVars with survey answers
    surveyVars:    
      ansible_VM_vmName: "{{vmName}}"
      ansible_CL_OS: "{{OS}}"
      ansible_CL_Application: "{{Application}}"
      ansible_CL_Tier: "{{Tier}}"
      ansible_CL_Environment: "{{Environment}}"
      ansible_CL_Location: "{{Location}}"
      ansible_CL_SQL: "{{SQL}}"    
    #the template to build a VM with some defautl variables defined
    vm:
      annotation: This is a VM
      cdrom:
        type: client
        iso_path: ''
        controller_type: ''
        state: ''
      cluster: ''
      convert: ''
      customization:
        existing_vm: 'False'
        dns_servers:
        - 10.7.200.95
        - 10.130.200.95
        dns_suffix: bhcs.pvt
        domain: bhcs.pvt
        hostname: ''
        autologon: ''
        autologoncount: ''
        domainadmin: ''
        domainadminpassword: ''
        fullname: ''
        joindomain: ''
        joinworkgroup: ''
        orgname: BHCS
        password: ''
        productid: ''
        runonce: ''
        timezone: '20'
      datacenter: ''
      disks:
      - size_gb: ''
        type: thin
      folder: ''
      force: ''
      hardware:
        hotadd_cpu: 'True'
        hotremove_cpu: ''
        hotadd_memory: 'True'
        memory_mb: ''
        num_cpus: ''
        num_cpu_cores_per_socket: ''
        scsi: ''
        version: ''
      is_template: ''
      networks:
      - name: ''
        vlan: ''
        device_type: vmxnet3
        mac: ''
        dvswitch_name: ''
        start_connected: 'True'
        type: static
        ip: ''
        netmask: ''
        gateway: ''
        dns_servers: ''
        domain: bhcs.pvt
        wake_on_lan: ''
        allow_guest_control: ''
      state: present
      template: ''
      validate_certs: 'False'
      wait_for_customization: 'yes'   

  tasks:
  # Some script to dump vars to pshell, which writes to txt file and returns some stuff
  # as a test of what we are getting back and forth from here to powershell and back
  #- name: "Run script '.ps1'"
  #  #Send dicts to powershell, they show up with u'*'. Powershell converts to json, 
  #  # then to pshell object for . notation, sets some values, sends back pure JSON
  #  win_shell: D:\scripts\outputValues.ps1 -surveyVars "{{surveyVars }}" -vm "{{vm }}" #-userName '{{ ansible_user }}' -password '{{ ansible_password }}'
  #  register: result
  #- name: Process win_shell output
  #  set_fact:
  #    vm: "{{ result.stdout | from_json }}"
  #- name: Return Values
  #  debug:
  #    msg: "{{ vm }}"

#ORIGINAL FILE
#deploy VM 1st try

  - name: 'set fact'
    set_fact: 
      pshellScriptAction: "getClusterBasedOnSurvey"
  
  - name: "Run script 'ansible_deployVM.ps1' and get cluster based on Survey"
    win_shell: D:\scripts\vSphere\ansible_selectClusterBasedOnSurvey.ps1 -pshellScriptAction "{pshellScriptAction}" -surveyVars "{{surveyVars }}" -vm "{{vm }}" -userName '{{ ansible_user }}' -password '{{ ansible_password }}'
    register: result
  
  - name: Process win_shell output
    set_fact:
      vm: "{{ result.stdout | from_json }}"
  
  - name: "the VM variable including Cluster Placement results are"
    debug: var="{vm}"

 # Send desitination cluster to pshell to determine available networks for that cluster
  - name: "Run script 'ansible_getNetworks_for_Cluster.ps1'"
    win_shell: D:\scripts\IPAM\ansible_getNetworks_for_Cluster.ps1 -clusterName '{{ destinationCluster }}' -userName '{{ ansible_user }}' -password '{{ ansible_password }}'
    register: pshellResult
  
  - name: "set fact pshell"
    set_fact: 
      destinationNetworks: "{{ pshellResult.stdout | trim }}"
  
  - name: "the networks available for cluster '{{destinationCluster}}' are"
    debug: var=destinationNetworks   
 
 # Send desitination networks to pshell to get / set useable IP. -setReservation true or false will set reservation or just return ip info
 # NEED TO SETUP A CREDENTIAL FOR PROTEUS
  - name: "Run script 'ansible_getBCIP_For_Reservation_Network.ps1'"
    win_shell: D:\scripts\IPAM\ansible_getBCIP_For_Reservation_Network.ps1 -requestedSubnets '{{ destinationNetworks }}' -vmName  '{{ surveyVars.vmName }}' -userName '{{ ansible_user }}' -password '{{ ansible_password }}' -setReservation false
    register: pshellResult
  
  - name: "set fact pshell"
    set_fact: 
      ipamResults: "{{ pshellResult.stdout | trim }}"
  
  - name: "the IPAM results are"
    debug: var=ipamResults

    #################################

           
